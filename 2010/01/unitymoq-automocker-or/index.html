<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Unity/Moq - AutoMocker or AutoMockingContainer - Developing on Staxmanade</title>
  <meta name="author" content="Jason Jarrett">


   <meta name="description" content="#### What is an Auto Mocking Container?">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <link rel="canonical" href="http://staxmanade.com/2010/01/unitymoq-automocker-or/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="http://feeds.feedburner.com/DevelopingOnStaxmande" rel="alternate" title="Developing on Staxmanade" type="application/atom+xml">
    <script src="/js/modernizr-2.0.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./js/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/js/octopress.js" type="text/javascript"></script>
    <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1017448-6']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>

</head>

<body  class=" ">
<header role="banner"><hgroup>
  <h1><a href="/">Developing on Staxmanade</a></h1>
</hgroup>

</header>
<nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/DevelopingOnStaxmande" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
</ul>
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:staxmanade.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/about">About</a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
<div id="main">
    <div id="content">

        <div>
            <article class="hentry" role="article">
                  <header>
    <h1 class="entry-title"><a href="http://staxmanade.com/2010/01/unitymoq-automocker-or/">Unity/Moq - AutoMocker or AutoMockingContainer</a></h1>
    <p class="meta">
          <time datetime="2010-01-03T16:53:00.000Z" pubdate data-updated="true">Jan 3rd 2010</time>


        
    </p>
</header>
<div class="entry-content"><h4 id="what-is-an-auto-mocking-container-">What is an Auto Mocking Container?</h4>
<p>This post started to get a little long, so I won&#39;t re-explain the concept.</p>
<p><a href="http://lostechies.com/joshuaflanagan/">Joshua Flanagan</a> wrote a nice overview at his <a href="http://www.lostechies.com/">Los Techies</a> blog: <a href="http://www.lostechies.com/blogs/joshuaflanagan/archive/2009/02/03/auto-mocking-explained.aspx">Auto mocking Explained</a>.</p>
<p>My post is mainly here to describe the Unity version of an automocking container I threw together.</p>
<h4 id="in-jan-2009-i-blogged-about-my-initial-version-of-the-unity-automocker-why-am-i-blogging-about-it-again-">In Jan 2009 I blogged about my initial version of the Unity AutoMocker - Why am I blogging about it again?</h4>
<p>I originally wrote the AutoMocker for the Unity container a year ago (Jan 2009, in Silverlight), and finally got around to placing the code up in the <a href="http://code.google.com/p/moq-contrib/">moq-contrib</a> project in June of 2009.</p>
<p>I&#39;m writing another post today in hopes to:</p>
<ol>
<li>Get some feedback on how this little snippet of code should continue.</li>
<li>Give a little more how-to/example code</li>
<li>Describe some updates I made since I originally created it. </li>
</ol>
<h4 id="where-can-i-get-it-">Where can I get it?</h4>
<p>This is one part where I&#39;d appreciate some feedback.</p>
<p>I have two slightly different versions out there (currently).</p>
<p>I have one version at the <a href="http://code.google.com/p/elegantcode/source/browse/#svn/trunk/Coders/JasonJarrett/UnityAutoMocker">ElegantCode</a> repository where I was working on it, and the other I threw up at <a href="http://code.google.com/p/moq-contrib/">moq-contrib</a>.</p>
<p>The core of the UnityAutoMockContainer is the same in both places, it&#39;s how the tests are separated out that differ.</p>
<p>In the <a href="http://code.google.com/p/elegantcode/source/browse/#svn/trunk/Coders/JasonJarrett/UnityAutoMocker">ElegantCode repository</a> it&#39;s an all in one self contained single file (that you can copy into your own test project(s)). You can then setup a single test in your own testing framework that runs all internal automocker tests (in case you need to modify it yourself, and don&#39;t want to break any existing functionality). EX: test</p>
<pre><code class="lang-C#">    [Test]
    public void Should_run_all_UnityAutoMockContainer_internal_tests()
    {
        Moq.AutoMocking.SelfTesting.UnityAutoMockContainerFixture.RunAllTests(Console.WriteLine);
    }
</code></pre>
<p>I kind of like this format as it makes it easy to port between test libraries. Can&#39;t say I like having the tests in the same file as the core, but it certainly is not a large chunk of code (so far) so it&#39;s relatively small to maintain and definitely easier to manage as a single .cs file than another assembly (which would have to be version dependent on both Unity and Moq).</p>
<p>The <a href="http://code.google.com/p/moq-contrib/">moq-contrib</a> is definitely where I think this helper should end up (and it is there). I just happened to break the tests out into the Silverlight test project and the core is alone in a file.</p>
<p>It&#39;s current state isn&#39;t as easy to copy to a test library (Silverlight/Desktop/Unity 1.2/Unity 2.0) as the one at <a href="http://elegantcode.com/">ElegantCode</a>. What does anyone think? Should I put them all together in one file?</p>
<p>However it ends up (1. all in one file or two (1 test) (1 core)) it will continue to be maintained on the <a href="http://code.google.com/p/moq-contrib/">moq-contrib</a> project.</p>
<h4 id="what-is-the-high-level-api-of-the-container-">What is the high level API of the container?</h4>
<p>It&#39;s pretty simple, (currently) there are four methods on the container.</p>
<p>Two for registering items with the container. Say you want to register an already created instance, or say you want to map an interface to a concrete class and <em>not</em> have the container generate mocks automatically for special cases.</p>
<p>And two for pulling items out of the container. Whether you want a instance of T or a Mock<T>, it gives you ways to retrieve both.</p>
<blockquote>
<p><img src="http://lh5.ggpht.com/_L6Vw0x_R3iw/S0DLkezvL7I/AAAAAAAAANQ/3CZqGQAh-fA/image_thumb1.png?imgmax=800" alt="image" title="image"></p>
</blockquote>
<h4 id="how-can-i-setup-my-own-registrations-with-the-container-">How can I setup my own registrations with the container?</h4>
<p>Say I don&#39;t want to have the container generate mocks for specific items and I want to supply specific configuration to the UnityContainer.</p>
<pre><code class="lang-C#"> public UnityAutoMockContainer RegisterInstance&lt;TService&gt;(TService instance)

 public UnityAutoMockContainer Register&lt;TService, TImplementation&gt;() 
     where TImplementation : TService
</code></pre>
<p>Note: both of these registration methods return the container itself so you can fluently stack registration. EX:</p>
<pre><code class="lang-C#">    AutoMockContainer
        .Register&lt;IServiceA, ServiceA&gt;()
        .Register&lt;IServiceB, ServiceB&gt;();
</code></pre>
<p>Let me know: I haven&#39;t tested or played around with how this automocking container deals with any container specific xml configuration… So although I don&#39;t think you should probably have that in a test assembly (stuff happens). Let me know if there are any issues.</p>
<h4 id="how-do-i-get-items-out-of-the-container-">How do I get items out of the container?</h4>
<p>First is the Resolve<T>(). It will pull an item T out of the container. (Creating it if not already existing)</p>
<p><code>public T Resolve&lt;T&gt;()</code></p>
<p>When T is an interface Resolve<T> (unless you setup registration specifically with the container) should return basically <code>(new Mock()).Object</code></p>
<p>When T is a concrete Class, the container should return an instance of T and any of it&#39;s dependencies will be satisfied by mocks. (Note that T will not be any sort of mocked instance of T, unless you used the GetMock as described below first)</p>
<p><code>public Mock GetMock() where T : class</code></p>
<p>When T is an interface GetMock should return basically <code>(new Mock())</code></p>
<p>When T is a concrete Class, the container should return a new Mock() and any of it&#39;s dependencies will be satisfied by mocks.</p>
<h4 id="how-do-i-use-the-unityautomockcontainer-">How do I use the UnityAutoMockContainer?</h4>
<p>It&#39;s pretty basic, you first create an instance of the UnityAutoMockContainer, and from there you can ask it for mocks of an (Interface, Class, or Abstract Class).</p>
<p>If you request an instance of a concrete class, or abstract class, the UnityAutoMockContainer will stuff mocks in for any constructor dependencies of your concrete class (if it can). You can then request from the container those same dependencies one at a time and either apply mocking setups or verifications.</p>
<blockquote>
<p>NOTE: Anything the container creates will live as a singleton instance in the container. So any other requests from the container will always return the originally created instance. Therefore, each distinct scenario in a test suite should have their own instances of the container.</p>
</blockquote>
<p>Below his an example of how you can leverage the container in some tests. Given this base fixture class…</p>
<pre><code class="lang-C#">public class FixtureBase
{
    private readonly UnityAutoMockContainer _autoMockContainer = new UnityAutoMockContainer();

    protected UnityAutoMockContainer AutoMockContainer
    {
        get { return _autoMockContainer; }
    }

    [TestFixtureSetUp]
    public void SetupContext_ALL()
    {
        Before_all_tests();
        Because();
    }

    [TestFixtureTearDown]
    public void TearDownContext_ALL()
    {
        After_all_tests();
    }

    protected virtual void Before_all_tests()
    {
    }

    protected virtual void Because()
    {
    }

    protected virtual void After_all_tests()
    {
    }
}
</code></pre>
<p>If I were given the following system to test.</p>
<pre><code class="lang-C#">public interface IServiceA { void RunA(); }
public interface IServiceB { void RunB(); }

public class TestComponent
{
    public TestComponent(IServiceA serviceA, IServiceB serviceB)
    {
        ServiceA = serviceA;
        ServiceB = serviceB;
    }

    public IServiceA ServiceA { get; private set; }
    public IServiceB ServiceB { get; private set; }

    public void RunAll()
    {
        if (!HowDidItGo())
            return;
        ServiceA.RunA();
        ServiceB.RunB();
    }

    public virtual bool HowDidItGo()
    {
        // some really nasty untestable code
        return true;
    }
}
</code></pre>
<p>The below example demonstrates simply verifying some behavior on the mocked dependencies of the system under test.</p>
<pre><code class="lang-C#">[TestFixture]
public class Example__how_to_pull_items_from_the_UnityAutoMockContainer_when_verifying_behavior_after_an_action_was_taken 
    : FixtureBase
{
    private TestComponent _testComponent;

    protected override void Before_all_tests()
    {
        base.Before_all_tests();
        _testComponent = AutoMockContainer.Resolve&lt;TestComponent&gt;();
    }

    protected override void Because()
    {
        _testComponent.RunAll();
    }

    [Test]
    public void Should_run_ServiceA_RunA()
    {
        AutoMockContainer
            .GetMock&lt;IServiceA&gt;()
            .Verify(v =&gt; v.RunA(), Times.Once());
    }

    [Test]
    public void Should_run_ServiceB_RunB()
    {
        AutoMockContainer
            .GetMock&lt;IServiceB&gt;()
            .Verify(v =&gt; v.RunB(), Times.Once());
    }
}
</code></pre>
<p>Next, you may have noticed that the system under test had a complicated internal method (that may not necessarily be testable). You can use the AutoMocker to create the system under test as a Mock itself, so we can override some of the behavior. Here&#39;s how you could quickly do that.</p>
<blockquote>
<p>Aside: I&#39;m not saying this is a good practice or aids in good component design, just saying it&#39;s possible</p>
</blockquote>
<pre><code class="lang-C#">[TestFixture]
public class Example__how_to_use_the_UnityAutoMockContainer_to_override_a_method_on_the_SystemUnderTest_to_test_a_certain_behavior
    : FixtureBase
{

    private TestComponent _testComponent;

    protected override void Before_all_tests()
    {
        base.Before_all_tests();
        var mockTestComponent = AutoMockContainer.GetMock&lt;TestComponent&gt;();

        mockTestComponent
            .Setup(s =&gt; s.HowDidItGo())
            .Returns(false);

        _testComponent = mockTestComponent.Object;
    }

    protected override void Because()
    {
        _testComponent.RunAll();
    }

    [Test]
    public void Should_run_ServiceA_RunA()
    {
        AutoMockContainer
            .GetMock&lt;IServiceA&gt;()
            .Verify(v =&gt; v.RunA(), Times.Never());
    }

    [Test]
    public void Should_run_ServiceB_RunB()
    {
        AutoMockContainer
            .GetMock&lt;IServiceB&gt;()
            .Verify(v =&gt; v.RunB(), Times.Never());
    }
}
</code></pre>
<p>It&#39;s amazing how much redundant test setup code this little helper has saved me in my tests. I hope others can find some use with this as well.</p>
</div>

                <footer>
                    <p class="meta">
                        <span class="byline author vcard">Posted by <span class="fn">Jason Jarrett</span></span>

                          <time datetime="2010-01-03T16:53:00.000Z" pubdate data-updated="true">Jan 3rd 2010</time>


                        
                    </p>
                    <div class="sharing">
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://staxmanade.com/2010/01/unitymoq-automocker-or/" data-via="staxmanade" data-counturl="http://staxmanade.com/2010/01/unitymoq-automocker-or/">Tweet</a>
</div>

                    <p class="meta">
                        <a class="basic-alignment left" href="/2009/12/powershell-load-assembly-without/" title="Previous Post: Powershell: Load assembly without locking file.">&laquo; Powershell: Load assembly without locking file.</a>
                        <a class="basic-alignment right" href="/2010/01/networking-brain-fart/" title="Next Post: Networking Brain Fart.">Networking Brain Fart. &raquo;</a>
                    </p>
                </footer>
            </article>
            <section>
                <h1>Comments</h1>
                <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
            </section>
        </div>

        <aside class="sidebar">
            <section>
	<!-- Begin MailChimp Signup Form -->
	<link href="//cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css">
	<style type="text/css">
		#mc_embed_signup input.button {
			width: inherit;
			padding-left: 10px;
			padding-right: 10px;
		}
	</style>
	<div id="mc_embed_signup">
		<form action="http://staxmanade.us8.list-manage1.com/subscribe/post?u=9a6f3f89fc58e1bbbddf5c3f8&amp;id=9e5406be65" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
			<h1>Subscribe</h1>
			<p>Enter your email to recive recent blog posts and other news</p>
			<input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
		    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
		    <div style="position: absolute; left: -5000px;"><input type="text" name="b_9a6f3f89fc58e1bbbddf5c3f8_9e5406be65" value=""></div>
			<div class=""><input type="submit" value="Subscribe to blog" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
		</form>
	</div>
	<!--End mc_embed_signup-->
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
      <li class="post">
        <a href="/2015/01/how-to-install-clang-format-and-formatting-objective-c-files/">How to install clang-format and formatting Objective-C files</a>
      </li>
      <li class="post">
        <a href="/2015/01/custom-static-blog-generator---no-longer-using-octopress/">Custom Static Blog Generator - No Longer Using Octopress</a>
      </li>
      <li class="post">
        <a href="/2014/12/use-different-git-diff-tools-per-file-extension/">Use different Git Diff Tools Per File Extension</a>
      </li>
      <li class="post">
        <a href="/2014/12/introducing-skypeit---command-line-skype-phone-calls/">Introducing SkypeIt - Command Line Skype Phone Calls</a>
      </li>
      <li class="post">
        <a href="/2014/12/thoughts-on-working-remotely-from-home/">Thoughts on Working Remotely from Home</a>
      </li>
      <li class="post">
        <a href="/2014/11/one-of-the-simplest-things-you-can-do-to-improve-email-communication/">One of the Simplest Things You can do to Improve Email Communication</a>
      </li>
      <li class="post">
        <a href="/2014/06/move-a-git-branch-while-on-a-different-branch/">Updating git branches.</a>
      </li>
  </ul>
</section>

<section>
  <h1>GitHub: <a href="https://github.com/staxmanade">@staxmanade</a></h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/js/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'staxmanade',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/js/github.js" type="text/javascript"> </script>
</section>


        </aside>

    </div>
</div>
<footer role="contentinfo"><p>
  Copyright &copy; 2015 - Jason Jarrett - <span class="credit">Powered by <a href="http://togglejs.github.io">Toggle</a></span>
</p>

</footer>
  
<script type="text/javascript">
      var disqus_shortname = 'developingonstaxmanade';
      
        var disqus_script = 'count.js';
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>



</body>
</html>
